<?php

namespace vendor\WebtreesModules\gvexport;

use Fisharebest\Webtrees\I18N;
use Fisharebest\Webtrees\Http\RequestHandlers\ControlPanel;
use Fisharebest\Webtrees\Individual;
use Fisharebest\Webtrees\Tree;

/**
 * @var string      $title                  title of this page
 * @var array       $vars                   array of saved settings
 * @var array       $otypes                 output file type options
 * @var ?           $module                 this module
 */
$settingsObj = new Settings();
$settings = $settingsObj->getDefaultSettings();
$usegraphviz = $vars['graphviz_bin'] != "";
?>

<?= view('components/breadcrumbs', ['links' => [route(ControlPanel::class) => I18N::translate('Control panel'), $title]]) ?>

<h1><?= $title ?></h1>
<p><?= I18N::translate('Values here are used as default values for new users of GVExport, and are used when users choose to reset the settings.'); ?></p>
<script src="<?= $module->assetUrl('javascript/gvexport.js'); ?>"></script>
<script type="text/javascript">
    let Url;
    import('<?= $module->assetUrl('javascript/MainPage/Url.js'); ?>').then((module)=>{
        Url = new module.Url();
        Url.removeURLParameter('reset');
    })
</script>
<link href="<?= $module->assetUrl('css/gvexport.css'); ?>" rel="stylesheet">

<div class="mb-5">
    <form method="post">
        <?= csrf_field() ?>
        <h2><?= I18N::translate('Settings for GVExport'); ?></h2>
        <div class="row form-group">
            <label class="col-sm-4 col-form-label"><?= I18N::translate('Administrator settings') ?></label>
            <div class="col-sm-8 wt-page-options-value">
                <label for="filename"><?= I18N::translate('Download file name') ?>:</label>
                <input class="form-control col-sm-6" type="text" name="vars[filename]" id="filename" value="<?= e($vars["filename"]) ?>">
                <label for="mclimit"><?= I18N::translate('Graphviz MCLIMIT setting') ?>:</label>
                <input class="form-control col-sm-6" type="text" name="vars[mclimit]" id="mclimit" value="<?= I18N::digits($vars["mclimit"]); ?>">
                <label for="birth_prefix"><?= I18N::translate('Birth date prefix') ?>:</label>
                <input class="form-control col-sm-6" type="text" name="vars[birth_prefix]" id="birth_prefix" pattern="^[A-Za-z0-9_ .*+()^%$#@!†-]*$" title="<?= I18N::translate("Letters, numbers, spaces, or the following symbols: ") . "_.*+()^%$#@!†-"; ?>" value="<?= e($vars["birth_prefix"]); ?>">
                <label for="death_prefix"><?= I18N::translate('Death date prefix') ?>:</label>
                <input class="form-control col-sm-6" type="text" name="vars[death_prefix]" id="death_prefix" pattern="^[A-Za-z0-9_ .*+()^%$#@!†-]*$" title="<?= I18N::translate("Letters, numbers, spaces, or the following symbols: ") . "_.*+()^%$#@!†-"; ?>" value="<?= e($vars["death_prefix"]); ?>">
            </div>
        </div>
        <div>
        </div>
        <h2><?= I18N::translate('Default values for GVExport'); ?></h2>

        <div>
            <div>
                <h3><?= I18N::translate('People to be included') ?></h3>
            </div>

            <div class="row no-right-margin form-group">
                <?php
                // Include the "People to be included" section of the settings
                echo view($module->name() . '::ControlPanel/PeopleToInclude',
                    [
                        'vars' => $vars,
                        'module' => $module,
                        'settings' => $settings
                    ]); ?>
            </div>
            <hr>
            <div>
                <h3><?= /* I18N: Appearance heading */ I18N::translate('Appearance') ?></h3>
            </div>
            <div class="row no-right-margin form-group">
                <?php
                // Include the "People to be included" section of the settings
                echo view($module->name() . '::ControlPanel/Appearance',
                    [
                        'vars' => $vars,
                        'module' => $module,
                        'settings' => $settings,
                        'usegraphviz' => $usegraphviz,
                    ]); ?>
            </div>
            <h3><?= /* I18N: Appearance heading */ I18N::translate('General Settings') ?></h3>
            <div class="row">
                <label class="col-sm-4 col-form-label" for="output_type"><?= I18N::translate('Output File Type') ?></label>
                <div class="col-sm-8 wt-page-options-value">
                    <?= view('components/select', ['name' => 'vars[output_type]', 'id' => 'output_type', 'selected' => e($vars['output_type']), 'options' => $otypes]) ?>
                </div>
                <label class="col-sm-4 col-form-label"><?= I18N::translate('Browser render') ?></label>
                <div class="col-sm-8 wt-page-options-value">
                    <label for="auto_update"><?= I18N::translate('Auto-update') ?></label>
                    <input type="checkbox" name="vars[auto_update]" id="auto_update" value="auto_update" <?= $vars["auto_update"] ? 'checked' : '' ?>>
                </div>
                <label class="col-sm-4 col-form-label" for="save_settings"><?= I18N::translate('Save settings') ?></label>
                <div class="col-sm-8 wt-page-options-value">
                    <div class="col-auto">
                        <input type="checkbox" name="vars[show_diagram_panel]" id="show_diagram_panel" value="show_diagram_panel" <?= $vars["show_diagram_panel"] ? 'checked' : '' ?>>
                        <label for="show_diagram_panel"><?= I18N::translate('Show saved diagrams panel') ?></label>
                    </div>
                </div>
            </div>
            <h3><?= I18N::translate('Debug') ?></h3>
            <div class="row form-group">
                <label class="col-sm-4 col-form-label"><?= I18N::translate('Debug mode') ?></label>
                <div class="col-sm-8 wt-page-options-value">
                    <label for="enable_debug_mode"><?= I18N::translate('Show debug panel') ?></label>
                    <input type="checkbox" name="vars[show_debug_panel]" id="show_debug_panel" value="show_debug_panel" <?= $vars["show_debug_panel"] ? 'checked' : '' ?>><br>
                </div>
                <label class="col-sm-4 col-form-label" for="enable_debug_mode"><?= I18N::translate('Debug mode') ?></label>
                <div class="col-sm-8 wt-page-options-value">
                    <label for="enable_debug_mode"><?= I18N::translate('Enable debug mode') ?></label>
                    <input type="checkbox" name="vars[enable_debug_mode]" id="enable_debug_mode" value="enable_debug_mode" <?= $vars["enable_debug_mode"] ? 'checked' : '' ?>><br>
                </div>
                <label class="col-sm-4 col-form-label" for="enable_graphviz"><?= I18N::translate('Graphviz') ?></label>
                <div class="col-sm-8 wt-page-options-value">
                    <label for="enable_graphviz"><?= I18N::translate('Use Graphviz on server') ?></label>
                    <input type="checkbox" name="vars[enable_graphviz]" id="enable_graphviz" value="enable_graphviz" onclick="setGraphvizAvailable(this.value==='enable_graphviz');" <?= $vars["enable_graphviz"] ? 'checked' : '' ?> <?= (new Settings())->getDefaultSettings()['graphviz_bin'] == "" ? "disabled" : ""; ?>><br></div>
            </div>
        </div>

        <input type="hidden" name="save" id="save" value="1">
        <button type="submit" class="btn btn-primary">
            <?= view('icons/save') ?>
            <?= I18N::translate('save') ?>
        </button>
        <?php $configLink = $module->getConfigLink();
            $resetLink = $configLink . (strpos($configLink, '?') ? "&" : "?") . "reset=1";
        ?>
        <a href="<?= $resetLink ?>" class="btn btn-outline-secondary"><?= I18N::translate('reset to defaults') ?></a>
    </form>
</div>