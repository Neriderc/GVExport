<?php

namespace vendor\WebtreesModules\gvexport;

use Fisharebest\Webtrees\Auth;
use Fisharebest\Webtrees\Contracts\UserInterface;
use Fisharebest\Webtrees\I18N;
use Fisharebest\Webtrees\Individual;
use Fisharebest\Webtrees\Registry;
use Fisharebest\Webtrees\Tree;


/*
 * tbd: better documentation of all transferred variables
 */

/**
 * @var string      $gvexport_css           used in javascript code as a link to the css file
 * @var string      $gvexport_js            used in javascript code as a link to the external script file
 * @var Tree        $tree                   used tree
 * @var Individual  $individual             The webtrees individual object of the XREF in the URL
 * @var string      $title                  title of this page
 * @var array       $vars                   array of saved settings
 * @var array       $otypes                 output file type options
 * @var bool        $cartempty              are there any individuals (INDI records) in the clippings cart?
 * @var ?           $module                 this module
 */

$settings = (new Settings($module))->getSettings();
$nographviz = $vars['graphviz_bin'] == "";
$xref = $individual->xref();
?>

<script type="text/javascript">
    // stylesheet
    const newSheet = document.createElement("link");
    newSheet.setAttribute("rel","stylesheet");
    newSheet.setAttribute("type","text/css");
    newSheet.setAttribute("href","<?= $gvexport_css ?>");
    document.head.appendChild(newSheet);

    function runPageLoaded() {
        if (typeof pageLoaded === 'function' && typeof jQuery === 'function') {
            changeURLXref('<?= $xref; ?>');
            pageLoaded();
        } else {
            // If external script loads before inline script, then wait
            // before trying to run page loaded function.
            setTimeout(runPageLoaded, 100);
        }
    }
    
    // Javascript functions
    const newScript = document.createElement("script");
    newScript.onload = function() {
        // Check that a) our function that runs on page load has been loaded, and
        // b), jQuery exists (as this comes via webtrees)
        runPageLoaded();
    };
    newScript.setAttribute("type","text/javascript");
    newScript.setAttribute("src","<?= $gvexport_js ?>");
    document.head.appendChild(newScript);
</script>
<script src="<?= $module->assetUrl('javascript/viz.js'); ?>"></script>
<script src="<?= $module->assetUrl('javascript/panzoom.min.js'); ?>"></script>
<script src="<?= $nographviz ? $module->assetUrl('javascript/jspdf.umd.min.js') : ""; ?>"></script>
<script type="text/javascript">
    const cartempty = <?= $cartempty ? "true" : "false" ?>;
    const CLIENT_ERRORS = ["<?= I18N::translate('Your browser does not support exporting images this large. Please reduce number of records, reduce DPI setting, or use SVG option.') ?>"];
    let autoUpdate = <?= $vars["auto_update"] == "auto_update" ? 'true' : 'false' ?>;
    let debug_string = "";
    let TOMSELECT_URL = "";
    let settings_json = "";
    const TREE_NAME = "<?= $tree->name(); ?>";
</script>

<h2 class="wt-page-title">
    <?= $title ?>
</h2>

<form action="<?= $module->chartUrl($individual) ?>" method="post" class="wt-page-options sidebar d-print-none" id="gvexport" onchange="formChanged(autoUpdate)">

    <div class="pull-right btn-hover">
        <a href="#" class="hide-form btn btn-secondary">X</a>
    </div>

    <div class="sidebar__formfields col">

        <?= csrf_field() ?>

        <div class="d-flex">
            <h3><?= I18N::translate('People to be included') ?></h3>
        </div>

        <?php
        /* Check if another module (e.g. vesta classic) is adding the XREF to
           the name. If so, we want to enable the XREF option for individuals
           unless we already have a saved setting */
        $startName = $individual->fullName();
        $name = str_replace(" (" . $xref . ")", "", $startName);
        if ($startName != $name && $vars["show_pid"] == "DEFAULT") {
            $overridePID = true;
        } else {
            $overridePID = false;
        }

        $greypeople = false;
        // Check if there are INDI records in the clippings cart, to decide what options to allow
        if (!$cartempty) {
        if ($vars["usecart"] == "usecart") {
            $greypeople = true;
        }
        ?>

            <div class="row form-group">
                <?= MainPage::addLabel('', 'Clippings cart'); ?>
                <div class="col-sm-8 wt-page-options-value">
                    <?= I18N::translate('You have items in the clippings cart, which can be used for the diagram instead of the below options.') ?>
                    <div class="col-sm-8 wt-page-options-value">
                        <div class="row">
                            <div class="col-auto mx-3">
                                <input type="radio" onclick="toggleCart(true)" name="vars[usecart]" id="usecart_yes" value="usecart" <?= $vars["usecart"] == "usecart" ? 'checked' : '' ?>>
                                <label for="usecart_yes"><?= I18N::translate('Use clippings cart') ?></label>
                            </div>
                            <div class="col-auto mx-3">
                                <input type="radio" onclick="toggleCart(false)" name="vars[usecart]" id="usecart_no" value="ignorecart" <?= $vars["usecart"] == "ignorecart" ? 'checked' : '' ?>>
                                <label for="usecart_no"><?= I18N::translate('Ignore clippings cart') ?></label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        <?php } ?>

        <div class="row form-group">
            <?= MainPage::addLabel('pid', 'Include anyone related to'); ?>
            <div class="col-sm-8 wt-page-options-value">
                <div id="indi_list">

                </div>
                <div id="clear_list"><a href="#" onclick="clearIndiList()"><?= I18N::translate('Clear all') ?></a></div>
                <div class="cart_toggle_hide" <?php if ($greypeople) { echo 'style="display: none"'; } ?>>
                    <?= view('components/select-individual', ['name' => 'pid', 'id' => 'pid', 'tree' => $tree, 'individual' => "", 'required'=>false]); ?>
                    <div class="red-text" id="indi-error"></div>
                </div>
            </div>
        </div>

        <div class="row form-group">
            <?= MainPage::addLabel('indiance', 'Include ancestors'); ?>
            <div class="col-sm-8 wt-page-options-value">
                <div class="row">
                    <div class="col-auto mx-3">
                        <input type="hidden" name="vars[indiance]" value="no">
                        <input class="cart_toggle" type="checkbox" name="vars[indiance]" id="indiance" value="ance" <?= $vars["indiance"] == "ance" ? 'checked' : '' ?>>
                    </div>
                    <div class="col-auto row">
                        <label for="ance_level" class="col-sm-6"><?= I18N::translate('Max levels') ?>:</label>
                        <input onblur="defaultValueWhenBlank(this, 0)" type="text" class="cart_toggle form-control col-sm-6" size="10" name="vars[ance_level]" id="ance_level" value="<?= $vars["ance_level"] ?>">
                    </div>
                </div>
            </div>
        </div>

        <div class="row form-group">
            <?= MainPage::addLabel('', 'Include'); ?>
            <div class="col-sm-8 wt-page-options-value">
                <div class="row">
                    <div class="col-auto mx-3">
                        <input type="hidden" name="vars[indisibl]" value="no">
                        <input class="cart_toggle" type="checkbox" onclick="updateRelationOption('indisibl')" name="vars[indisibl]" id="indisibl" value="sibl" <?= $vars["indisibl"] == "sibl" ? 'checked' : '' ?>>
                        <label for="indisibl"><?= I18N::translate('Siblings') ?></label>
                    </div>
                    <div class="col-auto mx-3">
                        <input type="hidden" name="vars[indicous]" value="no">
                        <input class="cart_toggle" onclick="updateRelationOption('indicous')" type="checkbox" name="vars[indicous]" id="indicous" value="cous" <?= $vars["indicous"] == "cous" ? 'checked' : '' ?>>
                        <label for="indicous"><?= I18N::translate('All relatives') ?></label>
                    </div>
                    <div class="col-auto mx-3">
                        <input type="hidden" name="vars[indispou]" value="no">
                        <input class="cart_toggle" type="checkbox" onclick="updateRelationOption('indispou')" name="vars[indispou]" id="indispou" value="spou" <?= $vars["indispou"] == "spou" ? 'checked' : '' ?>>
                        <label for="indispou"><?= I18N::translate('Partners') ?></label>
                    </div>
                    <div class="col-auto mx-3">
                        <input type="hidden" name="vars[indiany]" value="no">
                        <input class="cart_toggle" type="checkbox" onclick="updateRelationOption('indiany')" name="vars[indiany]" id="indiany" value="any" <?= $vars["indiany"] == "any" ? 'checked' : '' ?> <?= !$cartempty ? "disabled" : ""; ?>>
                        <label for="indiany"><?= I18N::translate('Anyone') ?></label>
                    </div>
                </div>
            </div>
        </div>

        <div class="row form-group">
            <?= MainPage::addLabel('indidesc', 'Include descendants'); ?>
            <div class="col-sm-8 wt-page-options-value">
                <div class="row">
                    <div class="col-auto mx-3">
                        <input type="hidden" name="vars[indidesc]" value="no">
                        <input class="cart_toggle" type="checkbox" name="vars[indidesc]" id="indidesc" value="desc" <?= $vars["indidesc"] == "desc" ? 'checked' : '' ?>>
                    </div>
                    <div class="col-auto row">
                        <label for="desc_level" class="col-sm-6"><?= I18N::translate('Max levels') ?>:</label>
                        <input onblur="defaultValueWhenBlank(this, 0)" type="text" class="cart_toggle form-control col-sm-6" size="10" name="vars[desc_level]" id="desc_level"
                               value="<?= $vars["desc_level"] ?>">
                    </div>
                </div>
            </div>
        </div>
        <div id="people-advanced" <?= $vars["adv_people"] == "show" ? '' : 'style="display:none"'; ?>>
            <div class="row form-group">
                <?= MainPage::addLabel('other_pids', 'XREFs of included individuals'); ?>
                <div class="col-sm-8 wt-page-options-value">
                    <div class="input-group mt-1">
                        <input type="text" class="form-control" name="vars[other_pids]" id="other_pids" value="<?= $vars['other_pids'] ?>" onchange="refreshIndisFromXREFS(true)">
                        <div class="input-group-append">
                            <button type="button" class="btn btn-outline-secondary" onclick="refreshIndisFromXREFS(false)">⟳</button>
                        </div>
                    </div>

                </div>
            </div>
            <div class="row form-group">
                <?= MainPage::addLabel('other_stop_pids', 'Stop processing on'); ?>
                <div class="col-sm-8 wt-page-options-value">
                    <div id="stop_indi_list">

                    </div>
                    <div id="clear_stop_list"><a href="#" onclick="clearStopIndiList()"><?= I18N::translate('Clear all') ?></a></div>
                    <div class="cart_toggle_hide" <?php if ($greypeople) { echo 'style="display: none"'; } ?>>
                        <?php
                        echo view('components/select-individual', ['name' => 'vars[stop_pid]', 'id' => 'stop_pid', 'tree' => $tree, 'xref' => '']);
                        ?>
                    </div>
                    <div class="input-group mt-1">
                        <input type="text" class="cart_toggle form-control" name="vars[other_stop_pids]" id="other_stop_pids" value="<?= $vars['other_stop_pids'] ?>" onchange="refreshIndisFromXREFS(true)">
                        <div class="input-group-append">
                            <button type="button" class="btn btn-outline-secondary" onclick="refreshIndisFromXREFS(false)">⟳</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row form-group">
                <?= MainPage::addLabel('marknr', 'Non-relatives'); ?>
                <div class="col-sm-8 wt-page-options-value">
                    <input type="hidden" name="vars[marknr]" value="no">
                    <input class="cart_toggle" onclick="setStateFastRelationCheck();" type="checkbox" name="vars[marknr]" id="marknr" value="marknr" <?= $vars["marknr"] == "marknr" ? 'checked' : '' ?>>
                    <label class="check-list" for="marknr"><?= I18N::translate('Mark not blood-related people with different color') ?></label>
                    <br/>
                    <input type="hidden" name="vars[fastnr]" value="no">
                    <input class="cart_toggle" type="checkbox" name="vars[fastnr]" id="fastnr" value="fastnr" <?= $vars["fastnr"] == "fastnr" ? 'checked' : '' ?>>
                    <label class="check-list" for="fastnr"><?= I18N::translate('Ignore unseen links to speed up relative check') ?></label>
                </div>
            </div>
        </div>
        <a href="#" id="people-advanced-button" onclick="toggleAdvanced(this, 'people-advanced')"><div class="wt-page-options-label advanced-settings-btn"><?= ($vars["adv_people"] == "show" ? '↑ ' : '↓ ') . I18N::translate('Toggle advanced settings') . ($vars["adv_people"] == "show" ? ' ↑' : ' ↓'); ?></div></a>

        <h3><?= I18N::translate('Appearance') ?></h3>
        <div class="row form-group">
            <?= MainPage::addLabel('grdir', 'Graph direction'); ?>
            <div class="col-sm-8 wt-page-options-value">
                <?= view('components/select', ['name' => 'vars[grdir]', 'id' => 'grdir', 'selected' => $vars['grdir'], 'options' => MainPage::updateTranslations($settings["directions"])]) ?>
            </div>
        </div>

        <div class="row form-group">
            <?= MainPage::addLabel('', 'Diagram type'); ?>
            <div class="col-sm-8 wt-page-options-value">
                <div class="row">
                    <div class="col-auto">
                        <input type="radio" onclick="togglePhotos(false)" name="vars[diagtype]" id="diagtype_simple" value="simple" <?= $vars["diagtype"] == "simple" ? 'checked' : '' ?>>
                        <label for="diagtype_simple"><?= I18N::translate('Simple') ?></label>
                    </div>
                    <div class="col-auto">
                        <input type="radio" onclick="togglePhotos(true)" name="vars[diagtype]" id="diagtype_decorated" value="decorated" <?= $vars["diagtype"] == "decorated" ? 'checked' : '' ?>>
                        <label for="diagtype_decorated"><?= I18N::translate('Decorated') ?></label>
                    </div>
                    <div class="col-auto">
                        <input type="radio" onclick="togglePhotos(true)" name="vars[diagtype]" id="diagtype_combined" value="combined" <?= $vars["diagtype"] == "combined" ? 'checked' : '' ?>>
                        <label for="diagtype_combined"><?= I18N::translate('Combined') ?></label>
                    </div>
                </div>
            </div>
        </div>

        <div id="appearance-advanced" <?= $vars["adv_appear"] == "show" ? '' : 'style="display:none"' ?>>

            <?php if ($tree->getPreference('SHOW_HIGHLIGHT_IMAGES') == '1') { ?>
                <div class="row form-group">
                    <?= MainPage::addLabel('with_photos', 'Add photos'); ?>
                    <div class="col-sm-8 wt-page-options-value">
                        <input type="hidden" name="vars[with_photos]" value="no">
                        <input type="checkbox" name="vars[with_photos]" id="with_photos" value="with_photos" <?= $vars["with_photos"] == "with_photos" ? 'checked' : '' ?>>
                        <span class="text-muted">(<?= I18N::translate('Only Decorated or Combined') ?>)</span>
                    </div>
                </div>
            <?php } ?>

            <div class="row form-group">
                <?= MainPage::addLabel('show_url', 'Add URL to individuals and families'); ?>
                <div class="col-sm-8 wt-page-options-value">
                    <input type="hidden" name="vars[show_url]" value="no">
                    <input type="checkbox" name="vars[show_url]" id="show_url" value="show_url" <?= $vars["show_url"] == "show_url" ? 'checked' : '' ?>>
                    <span class="text-muted">(<?= $nographviz ? I18N::translate('browser and SVG only') : I18N::translate('browser, SVG, and PDF only'); ?>)</span>
                </div>
            </div>

            <div class="row form-group">
                <?= MainPage::addLabel('use_abbr_name', 'Abbreviated names'); ?>
                <div class="col-sm-8 wt-page-options-value">
                    <?= view('components/select', ['name' => 'vars[use_abbr_name]', 'id' => 'use_abbr_name', 'selected' => $vars['use_abbr_name'], 'options' => MainPage::updateTranslations($settings["use_abbr_names"])]) ?>
                </div>
            </div>

            <div class="row form-group">
                <?= MainPage::addLabel('use_abbr_place', 'Abbreviated place names'); ?>
                <div class="col-sm-8 wt-page-options-value">
                    <?= view('components/select', ['name' => 'vars[use_abbr_place]', 'id' => 'use_abbr_place', 'selected' => $vars['use_abbr_place'], 'options' => MainPage::updateTranslations($settings["use_abbr_places"])]) ?>
                </div>
            </div>
            
            <div class="row form-group">
                <?= MainPage::addLabel('show_pid', 'Show individual XREF'); ?>
                <div class="col-sm-8 wt-page-options-value">
                    <input type="hidden" name="vars[show_pid]" value="no">
                    <input type="checkbox" name="vars[show_pid]" id="show_pid" value="show_pid" <?= $vars["show_pid"] == "show_pid" || $overridePID ? 'checked' : '' ?>>
                </div>
            </div>

            <div class="row form-group">
                <?= MainPage::addLabel('show_by', 'Show birth date'); ?>
                <div class="col-sm-8 wt-page-options-value">
                    <div class="row">
                        <div class="col-auto mx-3">
                            <input type="hidden" name="vars[show_by]" value="no">
                            <input type="checkbox" name="vars[show_by]" id="show_by" value="show_by" <?= $vars["show_by"] == "show_by" ? 'checked' : '' ?>>
                        </div>
                        <div class="col-auto mx-3">
                            <input type="radio" name="vars[bd_type]" id="bd_type_y" value="y" <?= $vars["bd_type"] == "y" ? 'checked' : '' ?>>
                            <label for="bd_type_y"><?= I18N::translate('Year') ?></label>
                        </div>
                        <div class="col-auto mx-3">
                            <input type="radio" name="vars[bd_type]" id="bd_type_gedcom" value="gedcom" <?= $vars["bd_type"] == "gedcom" ? 'checked' : '' ?>>
                            <label for="bd_type_gedcom"><?= I18N::translate('Full date') ?></label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row form-group">
                <?= MainPage::addLabel('show_bp', 'Show birth place'); ?>
                <div class="col-sm-8 wt-page-options-value">
                    <input type="hidden" name="vars[show_bp]" value="no">
                    <input type="checkbox" name="vars[show_bp]" id="show_bp" value="show_bp" <?= $vars["show_bp"] == "show_bp" ? 'checked' : '' ?>>
                </div>
            </div>

            <div class="row form-group">
                <?= MainPage::addLabel('show_dy', 'Show death date'); ?>
                <div class="col-sm-8 wt-page-options-value">
                    <div class="row">
                        <div class="col-auto mx-3">
                            <input type="hidden" name="vars[show_dy]" value="no">
                            <input type="checkbox" name="vars[show_dy]" id="show_dy" value="show_dy" <?= $vars["show_dy"] == "show_dy" ? 'checked' : '' ?>>
                        </div>
                        <div class="col-auto mx-3">
                            <input type="radio" name="vars[dd_type]" id="dd_type_y" value="y" <?= $vars["dd_type"] == "y" ? 'checked' : '' ?>>
                            <label for="dd_type_y"><?= I18N::translate('Year') ?></label>
                        </div>
                        <div class="col-auto mx-3">
                            <input type="radio" name="vars[dd_type]" id="dd_type_gedcom" value="gedcom" <?= $vars["dd_type"] == "gedcom" ? 'checked' : '' ?>>
                            <label for="dd_type_gedcom"><?= I18N::translate('Full date') ?></label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row form-group">
                <?= MainPage::addLabel('show_dp', 'Show death place'); ?>
                <div class="col-sm-8 wt-page-options-value">
                    <input type="hidden" name="vars[show_dp]" value="no">
                    <input type="checkbox" name="vars[show_dp]" id="show_dp" value="show_dp" <?= $vars["show_dp"] == "show_dp" ? 'checked' : '' ?>>
                </div>
            </div>


            <div class="row form-group">
                <?= MainPage::addLabel('show_fid', 'Show family XREF'); ?>
                <div class="col-sm-8 wt-page-options-value">
                    <input type="hidden" name="vars[show_fid]" value="no">
                    <input type="checkbox" name="vars[show_fid]" id="show_fid" value="show_fid" <?= $vars["show_fid"] == "show_fid" ? 'checked' : '' ?>>
                </div>
            </div>

            <div class="row form-group">
                <?= MainPage::addLabel('show_my', 'Show marriage date'); ?>
                <div class="col-sm-8 wt-page-options-value">
                    <div class="row">
                        <div class="col-auto mx-3">
                            <input type="hidden" name="vars[show_my]" value="no">
                            <input type="checkbox" name="vars[show_my]" id="show_my" value="show_my" <?= $vars["show_my"] == "show_my" ? 'checked' : '' ?>>
                        </div>
                        <div class="col-auto mx-3">
                            <input type="radio" name="vars[md_type]" id="md_type_y" value="y" <?= $vars["md_type"] == "y" ? 'checked' : '' ?>>
                            <label for="md_type_y"><?= I18N::translate('Year') ?></label>
                        </div>
                        <div class="col-auto mx-3">
                            <input type="radio" name="vars[md_type]" id="md_type_gedcom" value="gedcom" <?= $vars["md_type"] == "gedcom" ? 'checked' : '' ?>>
                            <label for="md_type_gedcom"><?= I18N::translate('Full date') ?></label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row form-group">
                <?= MainPage::addLabel('show_mp', 'Show marriage place'); ?>
                <div class="col-sm-8 wt-page-options-value">
                    <input type="hidden" name="vars[show_mp]" value="no">
                    <input type="checkbox" name="vars[show_mp]" id="show_mp" value="show_mp" <?= $vars["show_mp"] == "show_mp" ? 'checked' : '' ?>>
                </div>
            </div>

            <div class="row form-group">
                <?= MainPage::addLabel('dpi', 'DPI'); ?>
                <div class="col-sm-8 wt-page-options-value">
                    <div class="row">
                        <div class="col-auto">
                            <input type="text" onblur="defaultValueWhenBlank(this, 72)" class="form-control" size="10" name="vars[dpi]" id="dpi"
                                   value="<?= $vars["dpi"] ?>">
                        </div>
                    </div>
                </div>
            </div>

            <div class="row form-group">
                <?= MainPage::addLabel('', 'Space'); ?>
                <div class="col-sm-8 wt-page-options-value">
                    <div class="row">
                        <label for="ranksep"><?= I18N::translate('Between generations') ?>:</label>
                        <div class="col-auto">
                            <input type="text" onclick="togglePercent(this, false)" onblur="togglePercent(this, true)" class="form-control col-sm-6" size="10" name="vars[ranksep]" id="ranksep"
                                   value="<?= $vars["ranksep"] ?>">
                        </div>
                        <label for="nodesep"><?= I18N::translate('Between individuals on the same level') ?>:</label>
                        <div class="col-auto">
                            <input type="text" onclick="togglePercent(this, false)" onblur="togglePercent(this, true)" class="form-control col-sm-6" size="10" name="vars[nodesep]" id="nodesep"
                                   value="<?= $vars["nodesep"] ?>">
                        </div>
                    </div>
                </div>
            </div>
            <div class="row form-group">
                <?= MainPage::addLabel('', 'Font'); ?>
                <div class="col-sm-8 wt-page-options-value">
                    <div class="row">
                        <label for="typeface"><?= I18N::translate('Typeface') ?>:</label>
                        <div class="col-auto">
                            <?= view('components/select', ['name' => 'vars[typeface]', 'id' => 'typeface', 'selected' => $vars['typeface'], 'options' => MainPage::updateTranslations($settings["typefaces"])]) ?>
                        </div>
                        <label for="fontsize_name"><?= I18N::translate('Font size for names') ?>:</label>
                        <div class="col-auto">
                            <input type="text" class="form-control col-sm-6" size="10" name="vars[fontsize_name]" id="fontsize_name" value="<?= $vars["fontsize_name"] ?>">
                        </div>
                        <label for="fontsize"><?= I18N::translate('Font size for details') ?>:</label>
                        <div class="col-auto">
                            <input type="text" class="form-control col-sm-6" size="10" name="vars[fontsize]" id="fontsize" value="<?= $vars["fontsize"] ?>">
                        </div>
                        <div>
                            <input type="color" class="picker" name="vars[fontcolor_name]" id="fontcolor_name" value="<?= $vars["fontcolor_name"] ?>" /><label for="fontcolor_name" class="picker-label"><?= I18N::translate('Font color for names') ?></label>
                        </div>

                        <div>
                            <input type="color" class="picker" name="vars[fontcolor_details]" id="fontcolor_details" value="<?= $vars["fontcolor_details"] ?>" /><label for="fontcolor_details" class="picker-label"><?= I18N::translate('Font color for details') ?></label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row form-group">
                <?= MainPage::addLabel('', 'Relationship arrows'); ?>
                <div class="col-sm-8 wt-page-options-value">
                        <div class="col-auto">
                            <input type="color" class="picker" name="vars[arrow_default]" id="arrow_default" value="<?= $vars["arrow_default"] ?>" /><label for="arrow_default" class="picker-label"><?= I18N::translate('Arrow color') ?></label>
                        </div>
                        <input type="hidden" name="vars[color_arrow_related]" value="no">
                        <input type="checkbox" name="vars[color_arrow_related]" onclick="showHide(document.getElementById('arrow_group'),this.checked)" id="color_arrow_related" value="color_arrow_related" <?= $vars["color_arrow_related"] == "color_arrow_related" ? 'checked' : '' ?>><label for="color_arrow_related" class="check-list"><?= I18N::translate('Show blood relationship in different color') ?></label>

                        <div id="arrow_group" class="color_subgroup col-auto wt-page-options-value" <?= $vars["color_arrow_related"] != "color_arrow_related" ? 'style="display:none;"' : '' ?>>
                            <div class="sub-group">
                                <input type="color" class="picker" name="vars[arrow_related]" id="arrow_related" value="<?= $vars["arrow_related"] ?>" /><label for="arrow_related" class="picker-label"><?= I18N::translate('Related by birth') ?></label>
                                <input type="color" class="picker" name="vars[arrow_not_related]" id="arrow_not_related" value="<?= $vars["arrow_not_related"] ?>" /><label for="arrow_not_related" class="picker-label"><?= I18N::translate('Related other than by birth') ?></label>
                            </div>
                        </div>
                </div>
            </div>
            <div class="row form-group">
                <?= MainPage::addLabel('', 'Tile colors'); ?>
                <div class="col-sm-8 wt-page-options-value">
                    <div class="col-auto">
                        <input type="color" class="picker" name="vars[colorm]" id="colorm" value="<?= $vars["colorm"] ?>" /><label for="colorm" class="picker-label"><?= I18N::translate('Male individuals') ?></label>
                    </div>
                    <div class="col-auto">
                        <input type="color" class="picker" name="vars[colorf]" id="colorf" value="<?= $vars["colorf"] ?>" /><label for="colorf" class="picker-label"><?= I18N::translate('Female individuals') ?></label>
                    </div>
                    <div class="col-auto">
                        <input type="color" class="picker" name="vars[colorx]" id="colorx" value="<?= $vars["colorx"] ?>" /><label for="colorx" class="picker-label"><?= I18N::translate('Other gender individuals') ?></label>
                    </div>
                    <div class="col-auto">
                        <input type="color" class="picker" name="vars[coloru]" id="coloru" value="<?= $vars["coloru"] ?>" /><label for="coloru" class="picker-label"><?= I18N::translate('Unknown gender individuals') ?></label>
                    </div>
                    <div class="col-auto">
                        <input type="color" class="picker" name="vars[colorm_nr]" id="colorm_nr" value="<?= $vars["colorm_nr"] ?>" /><label for="colorm_nr" class="picker-label"><?= I18N::translate('Not blood-related male individuals') ?></label>
                    </div>
                    <div class="col-auto">
                        <input type="color" class="picker" name="vars[colorf_nr]" id="colorf_nr" value="<?= $vars["colorf_nr"] ?>" /><label for="colorf_nr" class="picker-label"><?= I18N::translate('Not blood-related female individuals') ?></label>
                    </div>
                    <div class="col-auto">
                        <input type="color" class="picker" name="vars[colorx_nr]" id="colorx_nr" value="<?= $vars["colorx_nr"] ?>" /><label for="colorx_nr" class="picker-label"><?= I18N::translate('Not blood-related other gender individuals') ?></label>
                    </div>
                    <div class="col-auto">
                        <input type="color" class="picker" name="vars[coloru_nr]" id="coloru_nr" value="<?= $vars["coloru_nr"] ?>" /><label for="coloru_nr" class="picker-label"><?= I18N::translate('Not blood-related unknown gender individuals') ?></label>
                    </div>
                    <div class="col-auto">
                        <input type="color" class="picker" name="vars[colorindibg]" id="colorindibg" value="<?= $vars["colorindibg"] ?>" /><label for="colorindibg" class="picker-label"><?= I18N::translate('Individual background color') ?></label>
                    </div>
                    <input type="hidden" name="vars[startcol]" value="false">
                        <input type="checkbox" name="vars[startcol]" onclick="showHide(document.getElementById('startcol_option'),this.checked)" id="startcol" value="true" <?= $vars["startcol"] == "true" ? 'checked' : '' ?>><label for="startcol" class="check-list"><?= I18N::translate('Show starting persons in different color') ?></label>
                    <div class="color_subgroup col-auto wt-page-options-value" id="startcol_option"  <?= $vars["startcol"] != "true" ? 'style="display:none;"' : '' ?>>
                        <input type="color" class="picker" name="vars[colorstartbg]" id="colorstartbg" value="<?= $vars["colorstartbg"] ?>" /><label for="colorstartbg" class="picker-label"><?= I18N::translate('Starting persons background color') ?></label>
                    </div>
                </div>
            </div>
            <div class="row form-group">
                <?= MainPage::addLabel('', 'Other colours'); ?>
                <div class="col-sm-8 wt-page-options-value">
                    <div class="col-auto">
                        <input type="color" class="picker" name="vars[colorfam]" id="colorfam" value="<?= $vars["colorfam"] ?>" /><label for="colorfam" class="picker-label"><?= I18N::translate('Family background') ?></label>
                    </div>
                    <div class="col-auto">
                        <input type="color" class="picker" name="vars[colorborder]" id="colorborder" value="<?= $vars["colorborder"] ?>" /><label for="colorborder" class="picker-label"><?= I18N::translate('Outline colour') ?></label>
                    </div>
                    <div class="col-auto">
                        <input type="color" class="picker" name="vars[colorbg]" id="colorbg" value="<?= $vars["colorbg"] ?>" /><label for="colorbg" class="picker-label"><?= I18N::translate('Diagram background color') ?></label>
                    </div>
                </div>
            </div>
        </div>
        <a href="#" id="appearance-advanced-button" onclick="toggleAdvanced(this, 'appearance-advanced')"><div class="wt-page-options-label advanced-settings-btn"><?= ($vars["adv_appear"] == "show" ? '↑ ' : '↓ ') . I18N::translate('Toggle advanced settings') . ($vars["adv_appear"] == "show" ? ' ↑' : ' ↓'); ?></div></a>
        <h3><?= I18N::translate('File settings') ?></h3>
        <div class="row form-group">
            <?= MainPage::addLabel('otype', 'Output file type'); ?>
            <div class="col-sm-8 wt-page-options-value">
                <?= view('components/select', ['name' => 'vars[otype]', 'id' => 'otype', 'selected' => $vars['otype'], 'options' => $otypes]) ?>
                <small id="emailHelp" class="form-text text-muted"><?= $nographviz ? I18N::translate("Options limited as Graphviz not installed on server") : "" ?></small>
            </div>
        </div>
        <div id="files-advanced" <?= $vars["adv_files"] == "show" ? '' : 'style="display:none"'; ?>>
            <div class="row form-group">
                <?= MainPage::addLabel('auto_update', 'Browser render'); ?>
                <div class="col-sm-8 wt-page-options-value">
                    <label for="auto_update"><?= I18N::translate('Auto-update') ?></label>
                    <input type="hidden" name="vars[auto_update]" value="no">
                    <input type="checkbox" onclick="toggleUpdateButton()" name="vars[auto_update]" id="auto_update" value="auto_update" <?= $vars["auto_update"] == "auto_update" ? 'checked' : '' ?>>
                </div>
                <?= MainPage::addLabel('', 'Settings file'); ?>
                <div class="col-sm-8 wt-page-options-value">
                    <label for="save_settings"><?= I18N::translate('Save settings to file') ?></label><br>
                    <button class="btn btn-outline-secondary" type="button" name="save_settings" id="save_settings" onclick="downloadSettingsFile(true)"><?= I18N::translate('Download') ?></button><br>
                    <label for="save_settings"><?= I18N::translate('Load settings from file') ?></label><br>
                    <input type="file" onchange="uploadSettingsFile(this)">
                </div>
            </div>
        </div>
        <a href="#" id="files-advanced-button" onclick="toggleAdvanced(this, 'files-advanced')"><div class="wt-page-options-label advanced-settings-btn"><?= ($vars["adv_files"] == "show" ? '↑ ' : '↓ ') . I18N::translate('Toggle advanced settings') . ($vars["adv_files"] == "show" ? ' ↑' : ' ↓'); ?></div></a>
        <? if ($settings["show_debug"] == "show_debug") { ?>
        <h3><?= I18N::translate('Debug') ?></h3>
        <div class="row form-group">
            <?= MainPage::addLabel('debug', 'Debug mode', FALSE); ?>
            <div class="col-sm-8 wt-page-options-value">
                <label for="debug"><?= I18N::translate('Enable debug mode') ?></label>
                <input type="hidden" name="vars[debug]" value="no">
                <input type="checkbox" name="vars[debug]" id="debug" value="debug" <?= $vars["debug"] == "debug" ? 'checked' : '' ?>><br>
                <button class="btn btn-outline-secondary" type="button" name="debug_view" onclick="return showHelp('debug');"><?= I18N::translate('View debug log') ?></button>
            </div>
            <?= MainPage::addLabel('use_graphviz', 'Graphviz', FALSE); ?>
            <div class="col-sm-8 wt-page-options-value">
                <label for="use_graphviz"><?= I18N::translate('Use Graphviz on server') ?></label>
                <input type="hidden" name="vars[use_graphviz]" value="no">
                <input type="checkbox" name="vars[use_graphviz]" id="use_graphviz" value="use_graphviz" onclick="setGraphvizAvailable(this.value==='use_graphviz');" <?= $vars["use_graphviz"] == "use_graphviz" ? 'checked' : '' ?> <?= $settings['graphviz_bin'] == "" ? "disabled" : ""?>><br></div>
        </div>
        <? } ?>
    </div>

    <div class="sidebar__buttons">
        <button type="submit" class="btn btn-primary update-browser-rendering" id="update-browser" <?php if ($vars["auto_update"] == "auto_update") { echo 'style="display: none"'; } ?>><?= I18N::translate('Update') ?></button>
        <button type="submit" class="btn btn-secondary main-action" name="download"><?= I18N::translate('Download') ?></button>
        <a href="<?= $module->chartUrl($individual, ['reset' => '1']) ?>" class="btn btn-outline-secondary"><?= I18N::translate('Reset') ?></a>
        <button class="btn btn-outline-secondary" name="help" onclick="return showHelp('Help')"><?= I18N::translate('Help') ?></button>
    </div>

    <input type="hidden" id="browser" name="browser" value="false">
    <input type="hidden" id="people-advanced-hidden" name="vars[adv_people]" value="<?= $vars["adv_people"] === "show" ? 'show' : '' ?>">
    <input type="hidden" id="appearance-advanced-hidden" name="vars[adv_appear]" value="<?= $vars["adv_appear"] === "show" ? 'show' : '' ?>">
    <input type="hidden" id="files-advanced-hidden" name="vars[adv_files]" value="<?= $vars["adv_files"] === "show" ? 'show' : '' ?>">
</form>

<div class="sidebar__toggler" hidden>
    <a href="#" class="btn btn-outline-secondary"><?= I18N::translate('Show options') ?></a>
</div>

<div id="render-container">
    <div id="rendering" hidden style="background-color: <?= $vars["colorbg"] ?>;"></div>
    <a href="#" title="<?= I18N::translate('Fullscreen') ?>" onclick="toggleFullscreen()" class="fullscreen" id="fullscreenButton">⛶</a>
    <a href="#" title="<?= I18N::translate('Exit fullscreen') ?>" onclick="toggleFullscreen()" class="fullscreen" id="fullscreenClose" style="display: none;">✖</a>
</div>

<script type="text/javascript">
    let graphvizAvailable = <?= $nographviz ? "false" : "true" ?>;
    let panzoomInst = null;
    const workerURL = '<?= $module->assetUrl('javascript/full.renderer.js'); ?>';
    let viz = new Viz({
        workerURL: workerURL
    });

    const form = document.getElementById('gvexport');
    const rendering = document.getElementById('rendering');


    // Trigger action when "Update" button clicked
    document.querySelector('.update-browser-rendering').addEventListener('click', function(e) {
        if (checkIndiBlank() === false) {
            updateRender();
            removeError("indi-error");
        } else {
            addError("indi-error","<?= I18N::translate("Individual required") ?>");
        }
        e.preventDefault();
    });

    // If "Download" button clicked
    document.querySelector('.main-action').addEventListener('click', function(e) {
        // first check that individual has been selected
        if (checkIndiBlank() === false) {
            removeError("indi-error");
        } else {
            addError("indi-error","<?= I18N::translate("Individual required") ?>");
            e.preventDefault();
        }
        // Also check if Graphviz installed. If so then let it handle it,
        // but if not, trigger client side actions
        if (!graphvizAvailable) {
            const output = document.getElementById('otype').value;
            switch(output) {
                case "png":
                    downloadSVGAsPNG();
                    break;
                case "svg":
                    downloadSVGAsText();
                    break;
                case "jpg":
                    downloadSVGAsJPEG();
                    break;
                case "pdf":
                    downloadSVGAsPDF();
                    break;
                default:
            }
            if (output !== "dot") {
                e.preventDefault();
            }
        }
    });

    function updateRender() {
        // Set browser value to true so we can return other info with DOT file
        // that can't be included with downloaded file
        document.getElementById("browser").value = "true";

        // Update render element background to match diagram background
        document.getElementById("rendering").style.background = document.getElementById("colorbg").value;

        // Enable disabled fields so they are included in serialised data - this means the values are remembered
        const el = document.getElementsByClassName("cart_toggle");
        for (let i = 0; i < el.length; i++) {
            el.item(i).disabled = false;
        }
        // Get the form data
        const data = jQuery(form).serialize();
        // Disable our fields again by indicating cart is enabled (only if items in cart)
        if (!cartempty && document.getElementById("usecart_yes").checked) {
            toggleCart(true);
        }
        setStateFastRelationCheck();
        document.getElementById("browser").value = "false";
        let lastDotStr, indiNum, famNum, messages;

        rendering.innerHTML = '<div class="d-flex justify-content-center h-100"><div class="spinner-border align-self-center" role="status"><span class="sr-only">Loading...</span></div></div>';
        rendering.hidden = false;

        const MARGIN = 50;
        const h = window.innerHeight - document.querySelector('.wt-header-wrapper').getBoundingClientRect().height - document.querySelector('.wt-footers').getBoundingClientRect().height;
        const w = window.innerWidth - MARGIN*2;
        const wtMainContainer = document.getElementsByClassName('wt-main-container').item(0);
        const wtTitle = document.getElementsByClassName("wt-page-title").item(0);
        // Set size of render element to fit browser
        document.getElementById('render-container').style.height = h + "px";
        document.getElementById('render-container').style.width = w + "px";
        document.getElementById('render-container').style.left = MARGIN + "px";
        // Set size of container element so webtrees footer is in the right place
        const totalHeight = MARGIN + wtTitle.getBoundingClientRect().height + getComputedProperty(wtTitle, 'margin-bottom') + h + getComputedProperty(wtMainContainer, 'padding-top');
        wtMainContainer.style.height = totalHeight + "px";

        window.fetch(form.getAttribute('action'), {
            method: form.getAttribute('method'),
            credentials: 'same-origin', // include, *same-origin, omit
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: data
        }).then(function (response) {
            if (!response.ok) {
                return response.text().then(function (errorText) {
                    return Promise.reject(errorText)
                });
            }
            return response.text();
        }).then(function (response) {
            let jsonResponse;
            // If login expires, we will get error page instead of JSON.
            // Reload if loading JSON fails
            try {
                jsonResponse = JSON.parse(response);
            } catch(e) {
                showToast("E:<?= I18N::translate('Login expired. Reloading page...'); ?>");
                showToast("E: " + e);
                setTimeout(function(){location.reload();}, 3000);
                return false;
            }
            lastDotStr = jsonResponse.dot;
            if (lastDotStr.indexOf("digraph WT_Graph {") !== -1) {
                messages = jsonResponse.messages;
                debug_string = jsonResponse.debug;
                settings_json = jsonResponse.settings;
            }

            const images = [...lastDotStr.matchAll(/<IMG[^>]+SRC="([^"]*)/gmi)].map(function (matches) {
                return {
                    path: matches[1],
                    width: '150px',
                    height: '150px'
                };
            });
            console.log("Starting render (found " + images.length + " images)");
            return viz.renderSVGElement(lastDotStr, {
                images: images
            });
        }).then(function (element) {
            // Now we have to clean up the generated SVG.

            // remove title tags, so we don't get weird data on hover,
            // instead this defaults to the XREF of the record
            const a = element.getElementsByTagName("a");
            for (let i = 0; i < a.length; i++) {
                a[i].removeAttribute("xlink:title");
            }
            //half of bug fix for photos not showing in browser - we change & to %26 in functions_dot.php
            element.innerHTML = element.innerHTML.replaceAll("%26", "&amp;");
            // Don't show anything when hovering on blank space
            element.innerHTML = element.innerHTML.replaceAll("<title>WT_Graph</title>", "");
            // Set SVG viewBox to height/width so image is not cut off
            element.setAttribute("viewBox", "0 0 "+element.getAttribute("width").replace("pt","")+" "+element.getAttribute("height").replace("pt",""));
            console.log("Appending SVG", element);
            // Clear current rendering then append new element to the page
            rendering.innerHTML = "";
            rendering.appendChild(element);
            const fullZoom = Math.min(4, rendering.getBoundingClientRect().width / element.getBBox().width);
            panzoomInst = panzoom(element, {
                maxZoom: 4,
                minZoom: fullZoom / 4,
                initialZoom: fullZoom,
                onTouch: function() {
                    // Fix links not working on mobile
                    return false; // tells the library to not preventDefault.
                }
            });
            if (messages !== "") {
                for (let i = 0; i < messages.length; i++) {
                    showToast(messages[i]);
                }
            }
            // Scroll render to last starting individual
            let indiList = document.getElementById('other_pids').value.split(",");
            for (let i = indiList.length-1; i>=0; i--) {
                if (indiList[i].trim() !== "") {
                    scrollToRecord(indiList[i].trim());
                    break;
                }
            }

            handleTileClick();

            return element;
        }).catch(function (error) {
            rendering.innerHTML = '<div class="alert alert-danger" role="alert"><?= I18N::translate('Error running GVExport in browser mode') ?>:<br>' + error + '</div>';
            if (lastDotStr) {
                rendering.innerHTML = rendering.innerHTML + '<h4>DOT contents</h4><pre id="dot-text"></pre>';
                document.getElementById('dot-text').appendChild(document.createTextNode(lastDotStr));
            }

            // Create a new Viz instance (@see Caveats page for more info)
            viz = new Viz({
                workerURL: workerURL
            });
        });
        return false;
    }

    // Add an error message to the page
    // id - the id of the element that holds the message
    // message - the text to show in the error message
    function addError(id, message) {
        let er = document.getElementById(id);
        er.innerText=message;
        let el = document.getElementsByClassName("sidebar__formfields");
        let form = document.getElementsByTagName("FORM");
        let pos = getPos(er,form.item(1));
        el.item(0).scrollTo(0,pos["y"]-70);
    }

    // Removes the error text in the provided element
    function removeError(id) {
        let er = document.getElementById(id);
        er.innerText="";
    }

    <?
    (new Help())->addHelpMessageJavaScript();
    ?>
</script>

<div id="toast-container"></div>

<template id=dropdown>
    <div style="position: relative; z-index: 10000">
        <a class="btn btn-secondary btn-sm m-0" style="position: relative; overflow: hidden" onclick="this.parentNode.querySelector('.content').hidden = false;">V</a>
        <ul class="content list-group" hidden>
            <li class="list-group-item">Klick!</li>
        </ul>
    </div>
</template>